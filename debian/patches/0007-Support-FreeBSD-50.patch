From 681dd6c82438333eca8d900de8c00346abff1f83 Mon Sep 17 00:00:00 2001
From: Unitrunker <unitrunker@gmail.com>
Date: Sat, 6 Jan 2018 13:20:43 -0600
Subject: [PATCH 07/12] Support FreeBSD (#50)

* Support FreeBSD
* FreeBSD build instructions.
* break up lines
---
 README.md                         | 22 ++++++++++++++++++++++
 libairspy/src/iqconverter_float.c | 17 +++++++++++++++++
 libairspy/src/iqconverter_int16.c |  4 ++++
 3 files changed, 43 insertions(+)

diff --git a/README.md b/README.md
index 20bcebc..6dfce5d 100644
--- a/README.md
+++ b/README.md
@@ -93,6 +93,28 @@ Debug version:
 
 `rm -rf *`
 
+## How to build host software on FreeBSD.
+
+### Get the prerequisites (from root)
+
+`pkg install git cmake`
+
+### Build
+
+`git clone https:\\github.com\airspy\airspyone_host.git`
+
+`cd airspyone_host`
+
+`mkdir build`
+
+`cd build`
+
+`cmake .. -DLIBUSB_LIBRARIES=/usr/lib/libusb.so`
+
+`make`
+
+(from root)
+`make install`
 
 ## Principal authors:
 
diff --git a/libairspy/src/iqconverter_float.c b/libairspy/src/iqconverter_float.c
index c079c35..ebf5a56 100644
--- a/libairspy/src/iqconverter_float.c
+++ b/libairspy/src/iqconverter_float.c
@@ -38,6 +38,18 @@ THE SOFTWARE.
   #define _aligned_free(mem) free(mem)
   #define _inline inline
   #define FIR_STANDARD
+#elif defined(__FreeBSD__)
+  #define USE_SSE2
+#include <immintrin.h>
+  #define _inline inline
+  #define _aligned_free(mem) free(mem)
+void *_aligned_malloc(size_t size, size_t alignment)
+{
+    void *result;
+    if (posix_memalign(&result, size, alignment) == 0)
+        return result;
+    return 0;
+}
 #elif defined(__GNUC__) && !defined(__MINGW64_VERSION_MAJOR)
   #include <malloc.h>
   #define _aligned_malloc(size, alignment) memalign(alignment, size)
@@ -189,7 +201,12 @@ static _inline float process_fir_taps(const float *kernel, const float *queue, i
 
 	__m128 t = _mm_add_ps(acc, _mm_movehl_ps(acc, acc));
 	acc = _mm_add_ss(t, _mm_shuffle_ps(t, t, 1));
+
+#ifdef __FreeBSD__
+	float sum = acc[0];
+#else
 	float sum = acc.m128_f32[0];
+#endif
 
 #endif
 
diff --git a/libairspy/src/iqconverter_int16.c b/libairspy/src/iqconverter_int16.c
index d38df68..abb3109 100644
--- a/libairspy/src/iqconverter_int16.c
+++ b/libairspy/src/iqconverter_int16.c
@@ -34,6 +34,10 @@ THE SOFTWARE.
   #define _aligned_malloc(size, alignment) malloc(size)
   #define _aligned_free(mem) free(mem)
   #define _inline inline
+#elif defined(__FreeBSD__)
+  #define _inline inline
+  #define _aligned_free(mem) free(mem)
+void * _aligned_malloc(size_t size, size_t alignment);
 #elif defined(__GNUC__) && !defined(__MINGW64_VERSION_MAJOR)
   #include <malloc.h>
   #define _aligned_malloc(size, alignment) memalign(alignment, size)
-- 
2.11.0

