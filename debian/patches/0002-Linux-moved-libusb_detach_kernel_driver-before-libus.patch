From f617e38202bd1373e7db2d98b5592258de72238c Mon Sep 17 00:00:00 2001
From: Benjamin Vernoux <bvernoux@gmail.com>
Date: Tue, 26 May 2015 23:57:37 +0200
Subject: [PATCH 02/10] Linux moved libusb_detach_kernel_driver before
 libusb_set_configuration

---
 libairspy/src/airspy.c | 30 +++++++++++++++---------------
 1 file changed, 15 insertions(+), 15 deletions(-)

--- a/libairspy/src/airspy.c
+++ b/libairspy/src/airspy.c
@@ -624,13 +624,6 @@
 
 						if (strncmp((const char*)serial_number, serial_number_expected, SERIAL_AIRSPY_EXPECTED_SIZE) == 0)
 						{
-							result = libusb_set_configuration(dev_handle, 1);
-							if (result != 0)
-							{
-								libusb_close(dev_handle);
-								*libusb_dev_handle = NULL;
-								continue;
-							}
 #ifdef __linux__
 							/* Check whether a kernel driver is attached to interface #0. If so, we'll 
 							 * need to detach it.
@@ -640,6 +633,13 @@
 								libusb_detach_kernel_driver(dev_handle, 0);
 							}
 #endif
+							result = libusb_set_configuration(dev_handle, 1);
+							if (result != 0)
+							{
+								libusb_close(dev_handle);
+								*libusb_dev_handle = NULL;
+								continue;
+							}
 							result = libusb_claim_interface(dev_handle, 0);
 							if (result != 0)
 							{
@@ -666,13 +666,6 @@
 				if (libusb_open(dev, libusb_dev_handle) == 0)
 				{
 					dev_handle = *libusb_dev_handle;
-					result = libusb_set_configuration(dev_handle, 1);
-					if (result != 0)
-					{
-						libusb_close(dev_handle);
-						*libusb_dev_handle = NULL;
-						continue;
-					}
 #ifdef __linux__
 					/* Check whether a kernel driver is attached to interface #0. If so, we'll 
 					 * need to detach it.
@@ -682,6 +675,13 @@
 						libusb_detach_kernel_driver(dev_handle, 0);
 					}
 #endif
+					result = libusb_set_configuration(dev_handle, 1);
+					if (result != 0)
+					{
+						libusb_close(dev_handle);
+						*libusb_dev_handle = NULL;
+						continue;
+					}
 					result = libusb_claim_interface(dev_handle, 0);
 					if (result != 0)
 					{
